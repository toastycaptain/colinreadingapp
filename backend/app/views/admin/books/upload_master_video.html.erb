<div class="panel">
  <h3>Upload Master Video (Mux)</h3>
  <p>
    Book: <strong><%= @book.title %></strong> (ID: <%= @book.id %>)
  </p>
  <p>
    This requests a one-time Mux Direct Upload URL and uploads the selected file straight to Mux.
    Processing status will update when webhooks are received.
  </p>

  <div style="margin-bottom: 12px;">
    <label for="master-video-file">Choose video file</label><br>
    <input id="master-video-file" type="file" accept="video/*" />
  </div>

  <button id="upload-master-video-btn" class="button">Create Upload URL and Upload</button>
  <p id="upload-status" style="margin-top: 12px;"></p>

  <p style="margin-top: 16px;">
    <%= link_to "Back to Book", admin_book_path(@book), class: "button" %>
  </p>
</div>

<script>
  (function() {
    const button = document.getElementById("upload-master-video-btn");
    const fileInput = document.getElementById("master-video-file");
    const status = document.getElementById("upload-status");
    const csrfToken = document.querySelector("meta[name='csrf-token']")?.content;
    const bookId = <%= @book.id %>;

    if (!button || !fileInput || !status) return;

    const setStatus = (text, isError = false) => {
      status.textContent = text;
      status.style.color = isError ? "#b91c1c" : "#166534";
    };

    button.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) {
        setStatus("Select a video file first.", true);
        return;
      }

      button.disabled = true;
      setStatus("Creating Mux upload URL...");

      try {
        const createResponse = await fetch("/admin/api/v1/mux/direct_uploads", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRF-Token": csrfToken,
          },
          body: JSON.stringify({ book_id: bookId }),
        });

        if (!createResponse.ok) {
          throw new Error(`Failed to create direct upload (${createResponse.status})`);
        }

        const payload = await createResponse.json();
        setStatus("Uploading file to Mux...");

        const uploadResponse = await fetch(payload.upload_url, {
          method: "PUT",
          headers: {
            "Content-Type": file.type || "video/mp4",
          },
          body: file,
        });

        if (!uploadResponse.ok) {
          throw new Error(`Mux upload failed (${uploadResponse.status})`);
        }

        setStatus(`Upload complete (upload id: ${payload.upload_id}). Waiting for Mux processing webhook...`);
      } catch (error) {
        setStatus(error.message || "Upload failed", true);
      } finally {
        button.disabled = false;
      }
    });
  })();
</script>
